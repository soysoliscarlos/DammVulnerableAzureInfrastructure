name: Deploy DAVI Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  terraform:
    name: 'Terraform Deploy'
    runs-on: ubuntu-latest
    environment: production

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v4

    # Install Python for CosmosDB setup scripts
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # Azure Login using Service Principal (App Registration)
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Alternative: Login using individual secrets
    # Uncomment this and comment out the above if using individual secrets
    # - name: Azure Login
    #   uses: azure/login@v2
    #   with:
    #     client-id: ${{ secrets.AZURE_CLIENT_ID }}
    #     tenant-id: ${{ secrets.AZURE_TENANT_ID }}
    #     client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
    #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # Install the latest version of Terraform CLI
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ">= 1.9.0"

    # Extract subscription ID from Azure credentials and set as environment variable
    - name: Set Subscription ID
      run: |
        SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
        if [ -z "$SUBSCRIPTION_ID" ] || [ "$SUBSCRIPTION_ID" = "null" ]; then
          echo "ERROR: Failed to extract subscription ID from AZURE_CREDENTIALS"
          exit 1
        fi
        echo "TF_VAR_subscription_id=$SUBSCRIPTION_ID" >> $GITHUB_ENV
      shell: bash

    # Initialize a new or existing Terraform working directory
    - name: Terraform Init
      run: terraform init

    # Checks that all Terraform configuration files adhere to a canonical format
    - name: Terraform Format
      run: terraform fmt -check
      continue-on-error: true

    # Validates the configuration files
    - name: Terraform Validate
      run: terraform validate

    # Generates an execution plan for Terraform
    - name: Terraform Plan
      run: terraform plan -input=false

    # Apply the Terraform configuration
    # Note: auto-approve is used for automation. In production, consider using a manual approval step.
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: terraform apply -auto-approve -input=false

    # Display the output URL
    - name: Display Target URL
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: terraform output Target_URL
